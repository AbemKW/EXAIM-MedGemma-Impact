{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://exaid.ai/schemas/exaid.trace.schema.json",
  "title": "EXAID Timed Trace Record",
  "description": "Schema for multi-agent system timed trace records (v2.0.0). Phase 2 traces are RAW stream captures - no derived units (ws_units, ctu) are stored. Derived units are computed during replay/evaluation. Note: Stream emissions are delta/chunks, not tokenizer-level tokens.",
  
  "oneOf": [
    { "$ref": "#/$defs/trace_meta" },
    { "$ref": "#/$defs/stream_delta" },
    { "$ref": "#/$defs/turn_boundary" }
  ],
  
  "$defs": {
    "trace_meta": {
      "type": "object",
      "description": "Trace-level metadata and provenance (first record in trace file)",
      "required": [
        "record_type",
        "schema_version",
        "case_id",
        "mas_run_id",
        "mac_commit",
        "model",
        "created_at",
        "t0_emitted_ms"
      ],
      "properties": {
        "record_type": {
          "type": "string",
          "const": "trace_meta",
          "description": "Record type discriminator"
        },
        "schema_version": {
          "type": "string",
          "const": "2.0.0",
          "description": "Schema version (frozen)"
        },
        "case_id": {
          "type": "string",
          "pattern": "^case-[a-z0-9-]+$",
          "description": "Reference to the clinical case being processed"
        },
        "mas_run_id": {
          "type": "string",
          "pattern": "^mas_[a-z0-9_]+$",
          "description": "Deterministic MAS generation campaign ID (input-derived, no date)"
        },
        "mac_commit": {
          "type": "string",
          "minLength": 7,
          "description": "Full git commit hash of MAC submodule used for generation"
        },
        "exaid_commit": {
          "type": "string",
          "description": "Git commit hash of EXAID repo that generated this trace"
        },
        "model": {
          "type": "string",
          "description": "LLM model name (e.g., gpt-4o-mini)"
        },
        "decoding": {
          "type": "object",
          "description": "Decoding parameters used for generation",
          "properties": {
            "temperature": { "type": "number" },
            "top_p": { "type": ["number", "null"] },
            "max_tokens": { "type": ["integer", "null"] },
            "seed": { "type": ["integer", "null"] }
          }
        },
        "created_at": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 timestamp of trace generation"
        },
        "t0_emitted_ms": {
          "type": "integer",
          "minimum": 0,
          "description": "Anchor timestamp: t_emitted_ms of first stream_delta record (ms since epoch)"
        },
        "t0_definition": {
          "type": "string",
          "const": "t_emitted_ms of first stream_delta record",
          "description": "Definition of t0 anchor (frozen). NOTE: turn_boundary records may have negative t_rel_ms if they occur before t0."
        },
        "stub_mode": {
          "type": "boolean",
          "description": "True if trace was generated using stub mode (not real MAC execution). Stub traces must not be used for evaluation."
        },
        "total_turns": {
          "type": "integer",
          "minimum": 0,
          "description": "Total number of turns in this trace"
        },
        "total_deltas": {
          "type": "integer",
          "minimum": 0,
          "description": "Total number of stream_delta records in this trace"
        }
      },
      "additionalProperties": false
    },
    
    "stream_delta": {
      "type": "object",
      "description": "A single streamed delta/chunk emission. RAW capture only - no derived units stored.",
      "required": [
        "record_type",
        "case_id",
        "seq",
        "turn_id",
        "agent_id",
        "delta_text",
        "t_emitted_ms",
        "t_rel_ms"
      ],
      "properties": {
        "record_type": {
          "type": "string",
          "const": "stream_delta",
          "description": "Record type discriminator"
        },
        "case_id": {
          "type": "string",
          "pattern": "^case-[a-z0-9-]+$",
          "description": "Reference to the clinical case"
        },
        "seq": {
          "type": "integer",
          "minimum": 0,
          "description": "Global sequence number across entire trace (strictly increasing)"
        },
        "turn_id": {
          "type": "integer",
          "minimum": 1,
          "description": "Turn number within the conversation"
        },
        "agent_id": {
          "type": "string",
          "description": "Identifier of the agent that produced this delta"
        },
        "delta_text": {
          "type": "string",
          "description": "Raw stream delta/chunk text as emitted by LLM (may be fragment, not tokenizer-level)"
        },
        "t_emitted_ms": {
          "type": "integer",
          "minimum": 0,
          "description": "Absolute emission timestamp (ms since epoch)"
        },
        "t_rel_ms": {
          "type": "integer",
          "minimum": 0,
          "description": "Relative to t0_emitted_ms from trace_meta (t_emitted_ms - t0). Always >= 0 for deltas."
        }
      },
      "additionalProperties": false
    },
    
    "turn_boundary": {
      "type": "object",
      "description": "Marks the start or end of a turn. NOTE: t_rel_ms may be negative for boundaries that occur before t0 (first delta).",
      "required": [
        "record_type",
        "case_id",
        "turn_id",
        "agent_id",
        "boundary",
        "seq",
        "t_ms",
        "t_rel_ms"
      ],
      "properties": {
        "record_type": {
          "type": "string",
          "const": "turn_boundary",
          "description": "Record type discriminator"
        },
        "case_id": {
          "type": "string",
          "pattern": "^case-[a-z0-9-]+$",
          "description": "Reference to the clinical case"
        },
        "turn_id": {
          "type": "integer",
          "minimum": 1,
          "description": "Turn number within the conversation"
        },
        "agent_id": {
          "type": "string",
          "description": "Identifier of the agent for this turn"
        },
        "boundary": {
          "type": "string",
          "enum": ["start", "end"],
          "description": "Whether this marks turn start or end"
        },
        "seq": {
          "type": "integer",
          "minimum": 0,
          "description": "Global sequence number across entire trace"
        },
        "t_ms": {
          "type": "integer",
          "minimum": 0,
          "description": "Timestamp of boundary event (ms since epoch)"
        },
        "t_rel_ms": {
          "type": "integer",
          "description": "Relative to t0_emitted_ms (t_ms - t0). May be NEGATIVE for turn_start boundaries that occur before first delta."
        },
        "content_hash": {
          "type": "string",
          "pattern": "^sha256:[a-f0-9]{64}$",
          "description": "SHA256 of concatenated delta_text for this turn (end boundary only)"
        },
        "content_hash_input": {
          "type": "string",
          "const": "UTF-8 bytes of concatenated delta_text in seq order for this turn",
          "description": "Definition of content_hash input (frozen)"
        }
      },
      "additionalProperties": false
    }
  },
  
  "examples": [
    {
      "record_type": "trace_meta",
      "schema_version": "2.0.0",
      "case_id": "case-33651373",
      "mas_run_id": "mas_1d5b227a_gpt4omini_a3b4c5d6_e7f8g9h0",
      "mac_commit": "1d5b227afa64fe3dd5eb7b7c0ef778a09501b220",
      "model": "gpt-4o-mini",
      "decoding": {"temperature": 1.0, "seed": null},
      "created_at": "2024-12-24T12:00:00Z",
      "t0_emitted_ms": 1703419200123,
      "t0_definition": "t_emitted_ms of first stream_delta record",
      "total_turns": 13,
      "total_deltas": 1523
    },
    {
      "record_type": "stream_delta",
      "case_id": "case-33651373",
      "seq": 42,
      "turn_id": 3,
      "agent_id": "doctor0",
      "delta_text": "Based",
      "t_emitted_ms": 1703419205678,
      "t_rel_ms": 5555
    },
    {
      "record_type": "turn_boundary",
      "case_id": "case-33651373",
      "turn_id": 3,
      "agent_id": "doctor0",
      "boundary": "start",
      "seq": 40,
      "t_ms": 1703419205500,
      "t_rel_ms": 5377
    },
    {
      "record_type": "turn_boundary",
      "case_id": "case-33651373",
      "turn_id": 3,
      "agent_id": "doctor0",
      "boundary": "end",
      "seq": 100,
      "t_ms": 1703419210000,
      "t_rel_ms": 9877,
      "content_hash": "sha256:e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
      "content_hash_input": "UTF-8 bytes of concatenated delta_text in seq order for this turn"
    }
  ]
}
