{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://exaid.ai/schemas/exaid.run.schema.json",
  "title": "EXAID Run Log Schema v1.5.0",
  "description": "Multi-record JSONL schema for EXAID evaluation run logs. Each line is a record of type: run_meta, tokengate_flush, buffer_decision, or summary_event.",
  
  "$comment": "Paper hook: Run logs use multi-record JSONL format for M6b reconstructability and per-event instrumentation (Section 3.2)",
  
  "oneOf": [
    {"$ref": "#/$defs/run_meta"},
    {"$ref": "#/$defs/tokengate_flush"},
    {"$ref": "#/$defs/buffer_decision"},
    {"$ref": "#/$defs/summary_event"}
  ],
  
  "$defs": {
    "run_meta": {
      "type": "object",
      "title": "Run Metadata Record",
      "description": "First record in run log, contains provenance and configuration",
      "required": [
        "record_type",
        "schema_name",
        "schema_version",
        "created_at",
        "case_id",
        "variant_id",
        "mas_run_id",
        "eval_run_id",
        "history_k",
        "trace_file_hash",
        "trace_dataset_hash",
        "tokengate_config_hash",
        "concept_extractor",
        "stoplists_provenance",
        "timestamp_derivation",
        "determinism"
      ],
      "properties": {
        "record_type": {
          "const": "run_meta"
        },
        "schema_name": {
          "const": "exaid.run"
        },
        "schema_version": {
          "type": "string",
          "pattern": "^\\d+\\.\\d+\\.\\d+$",
          "default": "1.5.0"
        },
        "created_at": {
          "type": "string",
          "format": "date-time",
          "description": "ISO-8601 UTC timestamp of run execution"
        },
        "case_id": {
          "type": "string",
          "pattern": "^case-[a-zA-Z0-9-]+$"
        },
        "variant_id": {
          "type": "string",
          "pattern": "^V[0-4]$"
        },
        "mas_run_id": {
          "type": "string",
          "pattern": "^mas_[a-z0-9_]+$",
          "description": "Trace generation campaign ID"
        },
        "eval_run_id": {
          "type": "string",
          "pattern": "^eval-[a-f0-9]{8}-[a-f0-9]{8}$",
          "description": "Deterministic evaluation batch ID: eval-<trace_dataset_hash_8>-<exaid_commit_8>"
        },
        "history_k": {
          "type": "integer",
          "minimum": 1,
          "description": "Number of previous summaries in context"
        },
        "concept_extractor": {
          "type": "object",
          "description": "Complete concept extractor configuration for provenance",
          "required": [
            "spacy_version",
            "scispacy_version",
            "scispacy_model",
            "linker_name",
            "linker_kb_version",
            "linker_resolve_abbreviations",
            "cui_score_threshold",
            "max_k",
            "min_entity_len",
            "concept_representation",
            "cui_normalization"
          ],
          "properties": {
            "spacy_version": {"type": "string"},
            "scispacy_version": {"type": "string"},
            "scispacy_model": {"type": "string"},
            "linker_name": {"type": "string"},
            "linker_kb_version": {
              "type": ["string", "null"],
              "description": "UMLS snapshot version (e.g., 2023AB)"
            },
            "linker_resolve_abbreviations": {"type": "boolean"},
            "linker_max_entities_per_mention": {"type": "integer"},
            "linker_threshold": {"type": "number"},
            "cui_score_threshold": {"type": "number"},
            "max_k": {"type": "integer"},
            "min_entity_len": {"type": "integer"},
            "concept_representation": {
              "type": "string",
              "enum": ["cui", "surface"]
            },
            "cui_normalization": {
              "type": "string",
              "enum": ["uppercase", "lowercase", "none"]
            },
            "entity_types_kept": {
              "type": "array",
              "items": {"type": "string"}
            },
            "stop_entities_count": {"type": "integer"},
            "stop_cuis_count": {"type": "integer"}
          }
        },
        "stoplists_provenance": {
          "type": "object",
          "description": "Single canonical location for stoplist provenance",
          "required": [
            "stop_entities_hash",
            "stop_cuis_hash",
            "stoplists_generated_at"
          ],
          "properties": {
            "stop_entities_hash": {
              "type": "string",
              "pattern": "^sha256:[a-f0-9]{64}$"
            },
            "stop_cuis_hash": {
              "type": "string",
              "pattern": "^sha256:[a-f0-9]{64}$"
            },
            "stoplist_df_report_hash": {
              "type": "string",
              "pattern": "^sha256:[a-f0-9]{64}$"
            },
            "stoplists_generated_at": {
              "type": "string",
              "format": "date-time"
            },
            "stoplists_generated_by_commit": {
              "type": ["string", "null"]
            }
          }
        },
        "timestamp_derivation": {
          "type": "object",
          "description": "How event timestamps were derived (no silent fallbacks)",
          "required": ["method", "fallback_method", "missing_t_emitted_ms_count"],
          "properties": {
            "method": {
              "type": "string",
              "const": "trace_t_emitted_ms"
            },
            "fallback_method": {
              "type": "string",
              "const": "run_start_time_plus_seq"
            },
            "derived_from_t_emitted": {"type": "integer"},
            "derived_from_fallback": {"type": "integer"},
            "missing_t_emitted_ms_count": {
              "type": "integer",
              "description": "Count of timestamps derived via fallback"
            }
          }
        },
        "determinism": {
          "type": "object",
          "description": "Deterministic serialization settings",
          "properties": {
            "gzip_mtime": {"const": 0},
            "json_sort_keys": {"const": true},
            "json_separators": {
              "type": "array",
              "items": {"type": "string"},
              "minItems": 2,
              "maxItems": 2
            }
          }
        },
        "trigger_policy": {
          "type": "string",
          "enum": ["full_exaid", "turn_end", "no_buffer", "no_tokengate", "no_novelty"]
        },
        "trace_file_hash": {
          "type": "string",
          "pattern": "^sha256:[a-f0-9]{64}$"
        },
        "trace_dataset_hash": {
          "type": "string",
          "pattern": "^sha256:[a-f0-9]{64}$",
          "description": "Hash of the trace dataset inputs"
        },
        "tokengate_config_hash": {
          "type": "string",
          "pattern": "^sha256:[a-f0-9]{64}$",
          "description": "Hash of TokenGate config for the variant"
        }
      }
    },
    
    "tokengate_flush": {
      "type": "object",
      "title": "TokenGate Flush Event",
      "description": "Logged when TokenGate accumulates enough tokens to flush",
      "required": [
        "record_type",
        "flush_index",
        "case_id",
        "variant_id",
        "timestamp",
        "start_seq",
        "end_seq",
        "accumulated_ctu"
      ],
      "properties": {
        "record_type": {"const": "tokengate_flush"},
        "flush_index": {"type": "integer", "minimum": 0},
        "case_id": {"type": "string"},
        "variant_id": {"type": "string"},
        "timestamp": {"type": "string", "format": "date-time"},
        "start_seq": {"type": "integer", "minimum": 0},
        "end_seq": {"type": "integer", "minimum": 0},
        "accumulated_ctu": {
          "type": "integer",
          "description": "CTU = ceil(len(text) / 4)"
        },
        "trigger_reason": {
          "type": "string",
          "enum": ["max_words", "boundary_cue", "silence_timer", "max_wait_timeout", "end_of_trace", "turn_end"],
          "description": "Reason for TokenGate flush: max_words (word count exceeded), boundary_cue (sentence boundary detected), silence_timer (inactivity timeout), max_wait_timeout (maximum wait exceeded), end_of_trace (trace ended), turn_end (turn boundary, V1 only)"
        },
        "text_hash": {
          "type": "string",
          "pattern": "^sha256:[a-f0-9]{64}$",
          "description": "Hash of flushed text for verification"
        }
      }
    },
    
    "buffer_decision": {
      "type": "object",
      "title": "BufferAgent Decision Event",
      "description": "Logged for each BufferAgent decision (M9 overhead tracking)",
      "required": [
        "record_type",
        "decision_index",
        "decision_id",
        "case_id",
        "variant_id",
        "timestamp",
        "input_ctu",
        "decision",
        "llm_usage"
      ],
      "properties": {
        "record_type": {"const": "buffer_decision"},
        "decision_index": {"type": "integer", "minimum": 0},
        "decision_id": {
          "type": "string",
          "pattern": "^case-[a-zA-Z0-9-]+-V[0-4]-bd-\\d{3}$"
        },
        "case_id": {"type": "string"},
        "variant_id": {"type": "string"},
        "timestamp": {"type": "string", "format": "date-time"},
        "input_ctu": {"type": "integer"},
        "start_seq": {"type": "integer"},
        "end_seq": {"type": "integer"},
        "decision": {
          "type": "string",
          "enum": ["summarize", "buffer", "discard"],
          "description": "BufferAgent decision outcome"
        },
        "filter_results": {
          "type": "object",
          "properties": {
            "completeness_passed": {"type": "boolean"},
            "value_passed": {"type": "boolean"},
            "novelty_passed": {"type": ["boolean", "null"]}
          }
        },
        "llm_usage": {
          "$ref": "#/$defs/llm_usage"
        },
        "latency_ms": {"type": "integer", "minimum": 0}
      }
    },
    
    "summary_event": {
      "type": "object",
      "title": "Summary Generation Event",
      "description": "Logged when a summary is generated",
      "required": [
        "record_type",
        "event_index",
        "event_id",
        "case_id",
        "variant_id",
        "timestamp",
        "start_seq",
        "end_seq",
        "schema_ok",
        "summary_semantics_text",
        "summary_ctu",
        "trigger_type",
        "summary_history_event_ids",
        "summarizer_input_hash",
        "limits_ok",
        "failure_mode",
        "llm_usage"
      ],
      "properties": {
        "record_type": {"const": "summary_event"},
        "event_index": {"type": "integer", "minimum": 0},
        "event_id": {
          "type": "string",
          "pattern": "^case-[a-zA-Z0-9-]+-V[0-4]-se-\\d{3}$",
          "description": "Deterministic, collision-free event ID"
        },
        "case_id": {"type": "string"},
        "variant_id": {"type": "string"},
        "timestamp": {"type": "string", "format": "date-time"},
        "start_seq": {
          "type": "integer",
          "description": "Start of window for M6a/M6b"
        },
        "end_seq": {
          "type": "integer",
          "description": "End of window for M6a/M6b"
        },
        "trigger_type": {
          "type": "string",
          "enum": ["turn_end", "tokengate_flush", "buffer_agent"],
          "description": "Trigger mechanism used to generate the summary"
        },
        "summary_history_event_ids": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^case-[a-zA-Z0-9-]+-V[0-4]-se-\\d{3}$"
          },
          "description": "Event IDs used in the summary history context"
        },
        "summarizer_input_hash": {
          "type": "string",
          "pattern": "^sha256:[a-f0-9]{64}$",
          "description": "Hash of summarizer input text"
        },
        "summarizer_input_text": {
          "type": "string",
          "description": "Optional raw summarizer input text"
        },
        "limits_ok": {
          "type": "boolean",
          "description": "True if summarizer inputs respected configured limits"
        },
        "failure_mode": {
          "type": ["string", "null"],
          "description": "Failure mode label when limits_ok or schema_ok is false"
        },
        "schema_ok": {
          "type": "boolean",
          "description": "True if summary parsed correctly"
        },
        "schema_error": {
          "type": ["string", "null"],
          "description": "Error message if schema_ok=false"
        },
        "summary_semantics_text": {
          "type": "string",
          "description": "Concatenated summary sections for concept extraction"
        },
        "summary_ctu": {
          "type": "integer",
          "description": "CTU of summary_semantics_text"
        },
        "summary_content": {
          "type": "object",
          "description": "Structured AgentSummary output",
          "properties": {
            "status_action": {"type": "string"},
            "key_findings": {"type": "string"},
            "differential_rationale": {"type": "string"},
            "uncertainty_confidence": {"type": "string"},
            "recommendation_next_step": {"type": "string"},
            "agent_contributions": {"type": "string"}
          }
        },
        "latest_summary_event_id": {
          "type": ["string", "null"],
          "description": "Event ID of previous summary for M6b reconstruction"
        },
        "new_buffer_text_hash": {
          "type": "string",
          "pattern": "^sha256:[a-f0-9]{64}$",
          "description": "Hash of new buffer text for M6b"
        },
        "llm_usage": {
          "$ref": "#/$defs/llm_usage"
        },
        "latency_ms": {"type": "integer", "minimum": 0}
      }
    },
    
    "llm_usage": {
      "type": "object",
      "title": "LLM Usage Record",
      "description": "Separates CTU (deterministic) from provider tokens (API-reported)",
      "properties": {
        "prompt_ctu": {
          "type": "integer",
          "description": "ceil(len(prompt_text) / 4)"
        },
        "completion_ctu": {
          "type": "integer",
          "description": "ceil(len(completion_text) / 4)"
        },
        "provider_prompt_tokens": {
          "type": ["integer", "null"],
          "description": "Tokens reported by LLM API (may differ from CTU)"
        },
        "provider_completion_tokens": {
          "type": ["integer", "null"],
          "description": "Tokens reported by LLM API"
        },
        "model_id": {
          "type": "string",
          "description": "LLM model identifier"
        }
      }
    }
  }
}
